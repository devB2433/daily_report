<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>统计分析 - {{ .title }}</title>
    <link rel="icon" type="image/x-icon" href="/static/img/favicon.ico">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Chart.js -->
    <link href="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <!-- Chart Data Labels -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- 自定义样式 -->
    <link href="/static/css/style.css" rel="stylesheet">
    <style>
        .navbar {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%) !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        .card-title {
            color: var(--bs-primary);
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .stats-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-2px);
        }
        .stats-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--bs-primary);
        }
        .stats-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">工作管理系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">首页</a>
                    </li>
                    <li class="nav-item d-none" id="projectsLink">
                        <a class="nav-link" href="/projects">项目管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/users">用户管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/reports/new">写日报</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/reports">我的日报</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/analytics">统计分析</a>
                    </li>
                </ul>
                <!-- 用户信息/登录按钮 -->
                <ul class="navbar-nav">
                    <li class="nav-item dropdown d-none" id="userDropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i>
                            <span id="username"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="handleLogout()">退出登录</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>统计分析</h2>
            <button class="btn btn-primary" onclick="refreshData()">
                <i class="bi bi-arrow-clockwise"></i> 刷新数据
            </button>
        </div>
        
        <!-- 时间范围选择器 -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <select class="form-select" id="presetRange">
                            <option value="today">今日</option>
                            <option value="week">本周</option>
                            <option value="month" selected>本月</option>
                            <option value="last_month">上月</option>
                            <option value="7days">最近7天</option>
                            <option value="30days">最近30天</option>
                            <option value="90days">最近90天</option>
                            <option value="quarter">本季度</option>
                            <option value="year">本年度</option>
                            <option value="custom">自定义范围</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="date" class="form-control" id="startDate">
                    </div>
                    <div class="col-md-4">
                        <input type="date" class="form-control" id="endDate">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 统计卡片 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="stats-value" id="totalUsers">-</div>
                        <div class="stats-label">总用户数</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="stats-value" id="totalProjects">-</div>
                        <div class="stats-label">总项目数</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="stats-value" id="monthlyReports">-</div>
                        <div class="stats-label">日报数</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="stats-value" id="monthlyHours">-</div>
                        <div class="stats-label">总工时</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 项目工时分布 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">项目工时分布</h5>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-primary active" onclick="switchChartType('pie')" id="pieChartBtn">
                        <i class="bi bi-pie-chart"></i> 饼图
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="switchChartType('bar')" id="barChartBtn">
                        <i class="bi bi-bar-chart"></i> 柱状图
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div style="height: 400px;">
                    <canvas id="projectHoursChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">项目工时趋势</h5>
                        <div class="chart-container">
                            <canvas id="projectTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">用户工时统计</h5>
                        <div style="height: 400px;">
                            <canvas id="userHoursChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 检查登录状态和管理员权限
        function checkLoginStatus() {
            fetch('/api/user/info')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.data.role !== 'admin') {
                            window.location.href = '/'; // 非管理员重定向到首页
                            return;
                        }
                        document.getElementById('username').textContent = data.data.username;
                        document.getElementById('userDropdown').classList.remove('d-none');
                        document.getElementById('projectsLink').classList.remove('d-none'); // 显示项目管理链接
                        loadAnalytics();
                    } else {
                        window.location.href = '/login';
                    }
                })
                .catch(error => {
                    console.error('Error checking login status:', error);
                    window.location.href = '/login';
                });
        }

        // 时间范围管理类
        class TimeRangeManager {
            constructor() {
                this.presetSelect = document.getElementById('presetRange');
                this.startDateInput = document.getElementById('startDate');
                this.endDateInput = document.getElementById('endDate');
                
                this.initializeEventListeners();
                this.setDefaultDates();
            }

            initializeEventListeners() {
                this.presetSelect.addEventListener('change', () => this.handlePresetChange());
                this.startDateInput.addEventListener('change', () => this.handleDateChange());
                this.endDateInput.addEventListener('change', () => this.handleDateChange());
            }

            setDefaultDates() {
                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

                this.startDateInput.value = this.formatDate(firstDayOfMonth);
                this.endDateInput.value = this.formatDate(lastDayOfMonth);
            }

            handlePresetChange() {
                const preset = this.presetSelect.value;
                const dates = this.getPresetDates(preset);
                
                this.startDateInput.value = this.formatDate(dates.start);
                this.endDateInput.value = this.formatDate(dates.end);

                if (preset !== 'custom') {
                    this.handleApply();
                }
            }

            handleDateChange() {
                this.presetSelect.value = 'custom';
                const startDate = this.startDateInput.value;
                const endDate = this.endDateInput.value;

                if (startDate && endDate && this.validateDateRange(startDate, endDate)) {
                    loadAnalytics({
                        start_date: startDate,
                        end_date: endDate,
                        preset: 'custom'
                    });
                }
            }

            handleApply() {
                const startDate = this.startDateInput.value;
                const endDate = this.endDateInput.value;
                const preset = this.presetSelect.value;

                if (!this.validateDateRange(startDate, endDate)) {
                    alert('请选择有效的日期范围！');
                    return;
                }

                // 重新加载统计数据
                loadAnalytics({
                    start_date: startDate,
                    end_date: endDate,
                    preset: preset
                });
            }

            getPresetDates(preset) {
                const today = new Date();
                const result = {
                    start: new Date(),
                    end: new Date()
                };

                switch (preset) {
                    case 'today':
                        result.start = today;
                        result.end = today;
                        break;
                    case 'week':
                        const firstDayOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
                        result.start = firstDayOfWeek;
                        result.end = new Date(firstDayOfWeek);
                        result.end.setDate(result.end.getDate() + 6);
                        break;
                    case 'month':
                        result.start = new Date(today.getFullYear(), today.getMonth(), 1);
                        result.end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                        break;
                    case 'last_month':
                        result.start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                        result.end = new Date(today.getFullYear(), today.getMonth(), 0);
                        break;
                    case '7days':
                        result.end = today;
                        result.start = new Date(today);
                        result.start.setDate(result.start.getDate() - 6);
                        break;
                    case '30days':
                        result.end = today;
                        result.start = new Date(today);
                        result.start.setDate(result.start.getDate() - 29);
                        break;
                    case '90days':
                        result.end = today;
                        result.start = new Date(today);
                        result.start.setDate(result.start.getDate() - 89);
                        break;
                    case 'quarter':
                        const quarter = Math.floor(today.getMonth() / 3);
                        result.start = new Date(today.getFullYear(), quarter * 3, 1);
                        result.end = new Date(today.getFullYear(), (quarter + 1) * 3, 0);
                        break;
                    case 'year':
                        result.start = new Date(today.getFullYear(), 0, 1);
                        result.end = new Date(today.getFullYear(), 11, 31);
                        break;
                }

                return result;
            }

            validateDateRange(startDate, endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                    return false;
                }
                
                if (start > end) {
                    return false;
                }
                
                // 限制查询范围不超过1年
                const oneYear = 365 * 24 * 60 * 60 * 1000;
                if (end - start > oneYear) {
                    return false;
                }
                
                return true;
            }

            formatDate(date) {
                return date.toISOString().split('T')[0];
            }

            getCurrentTimeRange() {
                return {
                    start_date: this.startDateInput.value,
                    end_date: this.endDateInput.value,
                    preset: this.presetSelect.value
                };
            }
        }

        // 修改现有的 loadAnalytics 函数
        function loadAnalytics(timeRange = null) {
            const url = new URL('/api/analytics/summary', window.location.origin);
            
            if (timeRange) {
                url.searchParams.append('start_date', timeRange.start_date);
                url.searchParams.append('end_date', timeRange.end_date);
                url.searchParams.append('preset', timeRange.preset);
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateStatCards(data.data);
                        updateCharts(data.data);
                    }
                })
                .catch(error => {
                    console.error('加载统计数据失败:', error);
                });
        }

        // 更新统计卡片
        function updateStatCards(data) {
            document.getElementById('totalUsers').textContent = data.total_users;
            document.getElementById('totalProjects').textContent = data.total_projects;
            document.getElementById('monthlyReports').textContent = data.monthly_reports;
            document.getElementById('monthlyHours').textContent = Math.round(data.monthly_hours);

            // 更新统计卡片的时间范围标签
            if (data.time_range) {
                const startDate = new Date(data.time_range.start_date);
                const endDate = new Date(data.time_range.end_date);
                const dateRangeText = startDate.toLocaleDateString() + ' 至 ' + endDate.toLocaleDateString();
                
                // 添加时间范围提示
                document.querySelectorAll('.stats-card').forEach(card => {
                    const label = card.querySelector('.stats-label');
                    if (label && (label.textContent === '日报数' || label.textContent === '总工时')) {
                        card.setAttribute('title', '统计范围：' + dateRangeText);
                    }
                });
            }
        }

        // 声明全局变量来存储图表实例和数据
        let projectHoursChart = null;
        let projectTrendChart = null;
        let userHoursChart = null;
        let currentChartType = 'pie';
        let summaryData = null;

        // 生成图表颜色
        function getChartColors(count) {
            const colorPalettes = [
                // 高对比度配色方案
                ['#FF3366', '#3366FF', '#33CC33', '#9933FF', '#FF9933'],  // 红、蓝、绿、紫、橙
                ['#FF4D4D', '#4D4DFF', '#00CC66', '#CC33FF', '#FFB366'],  // 亮红、亮蓝、翠绿、亮紫、浅橙
                ['#FF1A1A', '#1A1AFF', '#00FF00', '#CC00FF', '#FF8000'],  // 深红、深蓝、荧光绿、深紫、深橙
                ['#E60000', '#0000E6', '#00B300', '#B300B3', '#E66000']   // 暗红、暗蓝、暗绿、暗紫、暗橙
            ];

            let colors = [];
            let paletteIndex = 0;
            
            for (let i = 0; i < count; i++) {
                const palette = colorPalettes[paletteIndex % colorPalettes.length];
                colors.push(palette[i % palette.length]);
                if (i % palette.length === palette.length - 1) {
                    paletteIndex++;
                }
            }
            
            return colors;
        }

        // 切换图表类型
        function switchChartType(type) {
            currentChartType = type;
            // 更新按钮状态
            document.getElementById('pieChartBtn').classList.toggle('active', type === 'pie');
            document.getElementById('barChartBtn').classList.toggle('active', type === 'bar');
            
            // 重新渲染图表
            renderProjectHoursChart(summaryData.project_hours);
        }

        // 渲染项目工时分布图表
        function renderProjectHoursChart(data) {
            const ctx = document.getElementById('projectHoursChart').getContext('2d');
            
            // 如果已存在图表，销毁它
            if (projectHoursChart) {
                projectHoursChart.destroy();
            }

            const totalHours = data.reduce((sum, item) => sum + item.hours, 0);

            const chartConfig = {
                type: currentChartType,
                data: {
                    labels: data.map(item => item.project_name),
                    datasets: [{
                        label: '工时',
                        data: data.map(item => item.hours),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                            '#FF9F40', '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false
                        },
                        legend: {
                            position: currentChartType === 'pie' ? 'right' : 'top',
                            labels: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        datalabels: {
                            color: currentChartType === 'pie' ? '#fff' : '#666',
                            anchor: currentChartType === 'pie' ? 'center' : 'end',
                            align: currentChartType === 'pie' ? 'center' : 'top',
                            formatter: (value, ctx) => {
                                if (currentChartType === 'pie') {
                                    const percentage = ((value / totalHours) * 100).toFixed(1) + '%';
                                    return percentage;
                                } else {
                                    return value.toFixed(1) + '小时';
                                }
                            },
                            font: {
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const value = context.raw;
                                    const percentage = ((value / totalHours) * 100).toFixed(1);
                                    return `${context.label}: ${value.toFixed(1)}小时 (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: currentChartType === 'bar' ? {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '工时（小时）',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        }
                    } : undefined
                },
                plugins: [ChartDataLabels]
            };

            projectHoursChart = new Chart(ctx, chartConfig);
        }

        // 创建项目工时趋势图
        function createProjectTrendChart(data) {
            if (!data || !data.daily_stats || data.daily_stats.length === 0) return;

            const ctx = document.getElementById('projectTrendChart');
            if (!ctx) return;

            // 如果图表已存在，先销毁
            if (projectTrendChart) {
                projectTrendChart.destroy();
            }

            const projectsMap = new Map();
            data.daily_stats.forEach(day => {
                if (day.project_hours) {
                    day.project_hours.forEach(ph => {
                        if (ph && ph.project_id && ph.project_name) {
                            projectsMap.set(ph.project_id, ph.project_name);
                        }
                    });
                }
            });

            // 定义丰富的颜色方案
            const colorSchemes = [
                // 主色系列
                { borderColor: '#2196F3', backgroundColor: 'rgba(33, 150, 243, 0.1)' },  // 蓝色
                { borderColor: '#4CAF50', backgroundColor: 'rgba(76, 175, 80, 0.1)' },   // 绿色
                { borderColor: '#FF9800', backgroundColor: 'rgba(255, 152, 0, 0.1)' },   // 橙色
                { borderColor: '#E91E63', backgroundColor: 'rgba(233, 30, 99, 0.1)' },   // 粉色
                { borderColor: '#9C27B0', backgroundColor: 'rgba(156, 39, 176, 0.1)' },  // 紫色
                // 辅助色系列
                { borderColor: '#00BCD4', backgroundColor: 'rgba(0, 188, 212, 0.1)' },   // 青色
                { borderColor: '#FFC107', backgroundColor: 'rgba(255, 193, 7, 0.1)' },   // 琥珀色
                { borderColor: '#795548', backgroundColor: 'rgba(121, 85, 72, 0.1)' },   // 棕色
                { borderColor: '#607D8B', backgroundColor: 'rgba(96, 125, 139, 0.1)' },  // 蓝灰色
                { borderColor: '#8BC34A', backgroundColor: 'rgba(139, 195, 74, 0.1)' },  // 浅绿色
                // 扩展色系列
                { borderColor: '#673AB7', backgroundColor: 'rgba(103, 58, 183, 0.1)' },  // 深紫色
                { borderColor: '#FF5722', backgroundColor: 'rgba(255, 87, 34, 0.1)' },   // 深橙色
                { borderColor: '#009688', backgroundColor: 'rgba(0, 150, 136, 0.1)' },   // 茶色
                { borderColor: '#3F51B5', backgroundColor: 'rgba(63, 81, 181, 0.1)' },   // 靛蓝色
                { borderColor: '#CDDC39', backgroundColor: 'rgba(205, 220, 57, 0.1)' }   // 酸橙色
            ];

            const datasets = Array.from(projectsMap.entries()).map(([id, name], index) => {
                const colorScheme = colorSchemes[index % colorSchemes.length];
                const chartData = data.daily_stats.map(day => {
                    const projectHours = day.project_hours ? 
                        day.project_hours.find(ph => ph && ph.project_id === id) : null;
                    return projectHours ? projectHours.hours : 0;
                });
                
                return {
                    label: name,
                    data: chartData,
                    borderColor: colorScheme.borderColor,
                    backgroundColor: 'transparent',
                    fill: false,
                    tension: 0.4,
                    borderWidth: 2,
                    pointBackgroundColor: colorScheme.borderColor,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointHoverBorderWidth: 2,
                    pointHoverBackgroundColor: colorScheme.borderColor,
                    pointHoverBorderColor: '#fff'
                };
            });

            projectTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.daily_stats.map(day => {
                        const date = new Date(day.date);
                        return `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    }),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '当月项目工时趋势',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        },
                        legend: {
                            position: 'bottom',
                            align: 'start',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                boxWidth: 10,
                                boxHeight: 10,
                                font: {
                                    size: 12
                                },
                                generateLabels: function(chart) {
                                    const datasets = chart.data.datasets;
                                    return datasets.map((dataset, i) => ({
                                        text: dataset.label,
                                        fillStyle: dataset.borderColor,
                                        strokeStyle: dataset.borderColor,
                                        lineWidth: 2,
                                        hidden: !chart.isDatasetVisible(i),
                                        index: i,
                                        pointStyle: 'circle'
                                    }));
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#333',
                            bodyColor: '#666',
                            borderColor: '#ddd',
                            borderWidth: 1,
                            padding: 10,
                            boxPadding: 4,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)} 小时`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '工时',
                                padding: {
                                    bottom: 10
                                }
                            },
                            grid: {
                                color: '#e2e8f0'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + ' 小时';
                                },
                                padding: 8
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 15,
                                padding: 8
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 4,
                            hoverRadius: 6,
                            borderWidth: 0
                        },
                        line: {
                            borderWidth: 2
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }

        // 创建用户工时统计图
        function createUserHoursChart(data) {
            if (!data || !data.user_hours || data.user_hours.length === 0) return;

            const ctx = document.getElementById('userHoursChart');
            if (!ctx) return;

            // 如果图表已存在，先销毁
            if (userHoursChart) {
                userHoursChart.destroy();
            }

            // 计算最大工时值，用于设置Y轴的最大值
            const maxHours = Math.max(...data.user_hours.map(u => u.hours));
            // 向上取整到最接近的10的倍数，并增加一些空间
            const yAxisMax = Math.ceil(maxHours / 10) * 10 + 10;

            userHoursChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.user_hours.map(u => u.username),
                    datasets: [{
                        label: '工时',
                        data: data.user_hours.map(u => u.hours),
                        backgroundColor: getChartColors(data.user_hours.length),
                        borderWidth: 0,
                        maxBarThickness: 50  // 限制柱子最大宽度
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 20  // 为数据标签预留空间
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y.toFixed(1)} 小时`;
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: function(value) {
                                return value.toFixed(1) + ' 小时';
                            },
                            color: '#666',
                            font: {
                                weight: 'bold'
                            },
                            offset: 4
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: yAxisMax,  // 设置Y轴最大值
                            title: {
                                display: true,
                                text: '工时（小时）',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                stepSize: Math.ceil(yAxisMax / 10)  // 设置刻度间隔
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '用户',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                maxRotation: 45,  // 允许标签旋转
                                minRotation: 45   // 强制标签旋转
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // 更新图表
        function updateCharts(data) {
            if (!data) {
                console.error('No data available for charts');
                return;
            }

            summaryData = data; // 保存数据到全局变量

            // 按顺序创建所有图表
            renderProjectHoursChart(data.project_hours);
            createProjectTrendChart(data);
            createUserHoursChart(data);
        }

        // 处理退出登录
        function handleLogout() {
            document.cookie = 'token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            window.location.href = '/login';
        }

        // 添加刷新函数
        function refreshData() {
            loadAnalytics(timeRangeManager.getCurrentTimeRange());
        }

        // 监听 localStorage 变化
        window.addEventListener('storage', function(e) {
            if (e.key === 'reportDeleted') {
                refreshData();
            }
        });

        // 设置自动刷新
        setInterval(refreshData, 5 * 60 * 1000); // 每5分钟自动刷新一次

        // 页面加载时检查登录状态
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            timeRangeManager = new TimeRangeManager(); // 初始化时间范围管理器
        });

        // 声明全局变量
        let timeRangeManager;
    </script>
</body>
</html> 