<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>首页 - {{ .title }}</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 自定义样式 -->
    <link href="/static/css/style.css" rel="stylesheet">
    <style>
        .navbar {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%) !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .chart-container {
            position: relative;
            margin: auto;
            height: 300px;
            width: 100%;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">工作管理系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/">首页</a>
                    </li>
                    {{ if .isAdmin }}
                    <li class="nav-item">
                        <a class="nav-link" href="/projects">项目管理</a>
                    </li>
                    {{ end }}
                    <li class="nav-item">
                        <a class="nav-link" href="/reports/new">写日报</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/reports">我的日报</a>
                    </li>
                    {{ if .isAdmin }}
                    <li class="nav-item">
                        <a class="nav-link" href="/analytics">统计分析</a>
                    </li>
                    {{ end }}
                </ul>
                <!-- 用户信息 -->
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i>
                            {{ .username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/profile">个人信息</a></li>
                            <li><a class="dropdown-item" href="#" onclick="showCookies()">查看Cookie</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="handleLogout()">退出登录</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <!-- 每日工时图表 -->
            <div class="col-md-8 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">每日工时统计</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="dailyHoursChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 项目工时占比 -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">项目工时占比</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="projectHoursChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 日历视图 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">日报提交日历</h5>
                    </div>
                    <div class="card-body">
                        <div id="calendar" class="d-flex flex-wrap"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 处理退出登录
        function handleLogout() {
            document.cookie = 'token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            window.location.href = '/login';
        }

        // 加载每日工时图表
        function loadDailyHoursChart() {
            fetch('/api/reports/stats/monthly')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const dailyStats = data.data.daily_stats;
                        const dates = dailyStats.map(stat => stat.date);
                        const hours = dailyStats.map(stat => stat.total_hours);

                        const ctx = document.getElementById('dailyHoursChart').getContext('2d');
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: dates,
                                datasets: [{
                                    label: '工时',
                                    data: hours,
                                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: '工时'
                                        }
                                    }
                                }
                            }
                        });
                    }
                });
        }

        // 加载项目工时占比图表
        function loadProjectHours() {
            fetch('/api/reports/stats/monthly')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const projectStats = data.data.project_stats;
                        const projectNames = projectStats.map(stat => stat.project_name);
                        const projectHours = projectStats.map(stat => stat.hours);

                        const ctx = document.getElementById('projectHoursChart').getContext('2d');
                        new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: projectNames,
                                datasets: [{
                                    data: projectHours,
                                    backgroundColor: generateColors(projectHours.length),
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'right'
                                    }
                                }
                            }
                        });
                    }
                });
        }

        // 初始化日历
        function initializeCalendar() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');

            fetch(`/api/reports/status?year=${year}&month=${month}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const calendar = document.getElementById('calendar');
                        calendar.innerHTML = '';

                        data.data.forEach(day => {
                            const dayElement = document.createElement('div');
                            dayElement.className = `calendar-day m-1 p-2 rounded ${day.submitted ? 'bg-success text-white' : 'bg-light'}`;
                            dayElement.style.width = '40px';
                            dayElement.style.height = '40px';
                            dayElement.style.textAlign = 'center';
                            dayElement.textContent = day.date.split('-')[2];
                            calendar.appendChild(dayElement);
                        });
                    }
                });
        }

        // 生成随机颜色
        function generateColors(count) {
            const colorPalettes = [
                ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                ['#FF8A80', '#82B1FF', '#B9F6CA', '#FFD180', '#EA80FC'],
                ['#EF5350', '#42A5F5', '#66BB6A', '#FFA726', '#AB47BC'],
                ['#F44336', '#2196F3', '#4CAF50', '#FF9800', '#9C27B0']
            ];

            let paletteIndex = window.currentPaletteIndex || 0;
            const palette = colorPalettes[paletteIndex];
            const colors = [];

            for (let i = 0; i < count; i++) {
                const color = palette[i % palette.length];
                colors.push(color);
            }

            // 更新索引，循环使用四种色系
            window.currentPaletteIndex = (paletteIndex + 1) % colorPalettes.length;
            
            return colors;
        }

        // 显示Cookie
        function showCookies() {
            const cookies = document.cookie.split(';').map(cookie => cookie.trim());
            alert('当前Cookie:\n' + cookies.join('\n'));
        }

        // 页面加载时加载数据
        document.addEventListener('DOMContentLoaded', function() {
            // 检查登录状态
            fetch('/api/user/info')
                .then(response => {
                    if (response.status === 401) {
                        // 未登录或token无效，重定向到登录页面
                        window.location.href = '/login';
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.success) {
                        // 已登录，加载页面数据
                        loadDailyHoursChart();
                        loadProjectHours();
                        initializeCalendar();
                    }
                })
                .catch(error => {
                    console.error('检查登录状态失败:', error);
                    window.location.href = '/login';
                });
        });
    </script>
</body>
</html> 