# 工作日报系统授权说明文档

## 1. 概述

工作日报系统采用基于Cookie的认证机制和基于角色的访问控制（RBAC）系统。系统支持两种角色：管理员（admin）和普通用户（user）。

## 2. 用户认证

### 2.1 注册流程

1. 用户注册限制：
   - 仅允许使用 `@blingsec.cn` 域名的邮箱
   - 用户名只能包含英文字母
   - 密码必须满足以下要求：
     - 至少8位长度
     - 包含大小写字母
     - 包含数字
     - 包含特殊字符（@$!%*?&）

2. 特殊账户处理：
   - 用户名为 `admin` 或 `root` 的账户自动获得管理员权限
   - 系统初始化时会自动创建默认管理员账户：
     - 邮箱：admin@blingsec.cn
     - 密码：Kj#9mP$2nL5vB@8x

### 2.2 登录机制

1. 登录方式：
   - 使用邮箱和密码进行登录
   - 支持"记住我"功能（Cookie保持7天）

2. 会话管理：
   - 登录成功后通过Cookie保存用户信息
   - Cookie包含以下信息：
     - user_id：用户ID
     - username：用户名
     - role：用户角色

3. 会话时效：
   - 普通会话：24小时
   - 开启"记住我"：7天

### 2.3 密码安全

1. 密码存储：
   - 使用bcrypt算法加密存储
   - 数据库中从不保存明文密码

2. 密码重置：
   - 管理员可以重置其他用户的密码
   - 重置的新密码必须符合密码强度要求

## 3. 权限控制

### 3.1 角色定义

1. 管理员（admin）：
   - 完整的系统管理权限
   - 可以访问所有功能模块

2. 普通用户（user）：
   - 基本的日报管理权限
   - 受限的功能访问

### 3.2 功能权限矩阵

| 功能模块 | 管理员 | 普通用户 |
|---------|--------|----------|
| 查看首页 | ✓ | ✓ |
| 个人日报管理 | ✓ | ✓ |
| 项目管理 | ✓ | ✗ |
| 用户管理 | ✓ | ✗ |
| 统计分析 | ✓ | ✗ |
| 重置密码 | ✓ | ✗ |

### 3.3 API权限控制

1. 公开API（无需认证）：
   - `/api/login`
   - `/api/register`
   - `/api/logout`

2. 需要认证的API：
   - `/api/user/info`
   - `/api/projects`（GET）
   - `/api/reports/*`

3. 仅管理员可访问的API：
   - `/api/projects`（POST/PUT/DELETE）
   - `/api/users`
   - `/api/users/:id/reset-password`

## 4. 安全措施

### 4.1 防护机制

1. XSS防护：
   - 所有用户输入在前端和后端都进行转义处理
   - 使用安全的模板引擎

2. CSRF防护：
   - 使用安全的Cookie属性
   - API请求需要认证信息

3. 会话安全：
   - Cookie设置HttpOnly标志
   - 使用安全的会话管理机制

### 4.2 最佳实践

1. 密码管理：
   - 强制要求强密码
   - 密码加密存储
   - 定期提醒更改密码

2. 访问控制：
   - 最小权限原则
   - 基于角色的访问控制
   - 清晰的权限分层

## 5. 开发指南

### 5.1 添加新的受保护路由

```go
// 1. 需要用户登录的路由
authorized := api.Group("/", AuthMiddleware())
{
    authorized.GET("/your-route", YourHandler)
}

// 2. 需要管理员权限的路由
adminOnly := authorized.Group("/", RootRequired())
{
    adminOnly.POST("/admin-route", AdminHandler)
}
```

### 5.2 检查用户权限

```go
// 在处理函数中检查用户角色
role, exists := c.Get("role")
if !exists || role.(string) != "admin" {
    // 处理权限不足的情况
}
```

## 6. 注意事项

1. 密码安全：
   - 禁止在日志中打印密码信息
   - 禁止在前端明文传输密码
   - 定期审查密码策略

2. 会话管理：
   - 及时清理过期会话
   - 正确处理登出操作
   - 监控异常登录行为

3. 权限控制：
   - 始终验证用户权限
   - 避免权限提升漏洞
   - 保持最小权限原则 