<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .title }}</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <!-- 自定义样式 -->
    <link href="/static/css/style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">工作管理系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/projects">项目管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/reports/new">写日报</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/reports">我的日报</a>
                    </li>
                </ul>
                <!-- 用户信息/登录按钮 -->
                <ul class="navbar-nav">
                    <li class="nav-item dropdown d-none" id="userDropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i>
                            <span id="username"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/profile">个人信息</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="handleLogout()">退出登录</a></li>
                        </ul>
                    </li>
                    <li class="nav-item" id="loginLink">
                        <a class="nav-link" href="/login">登录</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">欢迎使用工作管理系统</h5>
                        <p class="card-text">这是一个帮助您管理项目和日报的系统。</p>
                        <div class="d-flex gap-2">
                            <a href="/reports/new" class="btn btn-primary">写日报</a>
                            <a href="/projects" class="btn btn-outline-primary">查看项目</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">快速统计</h5>
                        <ul class="list-group list-group-flush" id="reportStats">
                            <li class="list-group-item">本周已写：<span id="weeklyCount">-</span> 篇</li>
                            <li class="list-group-item">本月已写：<span id="monthlyCount">-</span> 篇</li>
                            <li class="list-group-item">总计：<span id="totalCount">-</span> 篇</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer mt-auto py-3 bg-light">
        <div class="container text-center">
            <span class="text-muted">© 2024 工作管理系统</span>
        </div>
    </footer>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 检查登录状态
        function checkLoginStatus() {
            fetch('/api/user/info')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 显示用户信息
                        document.getElementById('username').textContent = data.data.username;
                        document.getElementById('userDropdown').classList.remove('d-none');
                        document.getElementById('loginLink').classList.add('d-none');
                        
                        // 如果是管理员，显示项目管理链接
                        if (data.data.role === 'admin') {
                            document.getElementById('projectManageLink').classList.remove('d-none');
                        }

                        // 加载日报统计
                        loadReportStats();
                    } else {
                        // 显示登录链接
                        document.getElementById('userDropdown').classList.add('d-none');
                        document.getElementById('loginLink').classList.remove('d-none');
                        document.getElementById('projectManageLink').classList.add('d-none');
                    }
                })
                .catch(error => {
                    console.error('Error checking login status:', error);
                    // 显示登录链接
                    document.getElementById('userDropdown').classList.add('d-none');
                    document.getElementById('loginLink').classList.remove('d-none');
                    document.getElementById('projectManageLink').classList.add('d-none');
                });
        }

        // 加载日报统计
        function loadReportStats() {
            fetch('/api/reports')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const now = new Date();
                        const reports = data.data;
                        
                        // 计算本周和本月的日报数量
                        const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
                        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                        
                        const weeklyCount = reports.filter(r => new Date(r.date) >= weekStart).length;
                        const monthlyCount = reports.filter(r => new Date(r.date) >= monthStart).length;
                        
                        document.getElementById('weeklyCount').textContent = weeklyCount;
                        document.getElementById('monthlyCount').textContent = monthlyCount;
                        document.getElementById('totalCount').textContent = reports.length;
                    }
                });
        }

        // 处理退出登录
        function handleLogout() {
            document.cookie = 'token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            window.location.href = '/login';
        }

        // 页面加载时检查登录状态
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
        });
    </script>
</body>
</html> 