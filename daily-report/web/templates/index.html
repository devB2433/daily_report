<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .title }}</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <!-- 自定义样式 -->
    <link href="/static/css/style.css" rel="stylesheet">
    <!-- 添加 Chart.js -->
    <link href="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <style>
        .fc {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .fc-header-toolbar {
            padding: 1rem;
            margin-bottom: 0 !important;
        }
        .fc-day-today {
            background-color: rgba(var(--bs-primary-rgb), 0.05) !important;
        }
        .fc-daygrid-day {
            transition: background-color 0.2s;
        }
        .fc-daygrid-day:hover {
            background-color: rgba(var(--bs-primary-rgb), 0.03);
        }
        .report-submitted {
            position: relative;
        }
        .report-submitted::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #28a745;
            box-shadow: 0 1px 3px rgba(40, 167, 69, 0.3);
        }
        .report-missing {
            position: relative;
        }
        .report-missing::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #dc3545;
            box-shadow: 0 1px 3px rgba(220, 53, 69, 0.3);
        }
        .fc-button-primary {
            background-color: var(--bs-primary) !important;
            border-color: var(--bs-primary) !important;
        }
        .fc-button-primary:hover {
            background-color: #0056b3 !important;
            border-color: #0056b3 !important;
        }
        .fc-col-header {
            background-color: #f8f9fa;
        }
        .fc-col-header-cell {
            padding: 8px 0 !important;
        }
        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        .card-title {
            color: var(--bs-primary);
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .navbar {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%) !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .status-legend {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
            padding: 0.5rem;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .status-dot.submitted {
            background-color: #28a745;
            box-shadow: 0 1px 3px rgba(40, 167, 69, 0.3);
        }
        .status-dot.missing {
            background-color: #dc3545;
            box-shadow: 0 1px 3px rgba(220, 53, 69, 0.3);
        }
        .project-hours-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .project-hours-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #eee;
        }
        .project-hours-item:last-child {
            border-bottom: none;
        }
        .project-name {
            font-weight: 500;
            color: var(--bs-primary);
        }
        .project-hours {
            font-weight: 600;
            color: #666;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">工作管理系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/">首页</a>
                    </li>
                    <li class="nav-item d-none" id="projectsLink">
                        <a class="nav-link" href="/projects">项目管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/reports/new">写日报</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/reports">我的日报</a>
                    </li>
                    <li class="nav-item d-none" id="analyticsLink">
                        <a class="nav-link" href="/analytics">统计分析</a>
                    </li>
                </ul>
                <!-- 用户信息/登录按钮 -->
                <ul class="navbar-nav">
                    <li class="nav-item dropdown d-none" id="userDropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i>
                            <span id="username"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/profile">个人信息</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="handleLogout()">退出登录</a></li>
                        </ul>
                    </li>
                    <li class="nav-item" id="loginLink">
                        <a class="nav-link" href="/login">登录</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">欢迎使用工作管理系统</h5>
                        <p class="card-text">这是一个帮助您管理项目和日报的系统。</p>
                        <div class="d-flex gap-2">
                            <a href="/reports/new" class="btn btn-primary">写日报</a>
                            <a href="/projects" class="btn btn-outline-primary">查看项目</a>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-body">
                        <h5 class="card-title">每日工时趋势</h5>
                        <div class="chart-container">
                            <canvas id="dailyHoursChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-body">
                        <h5 class="card-title">本月项目工时统计</h5>
                        <div class="project-hours-list" id="projectHoursList">
                            <!-- 项目工时列表将通过JavaScript动态加载 -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">日报提交日历</h5>
                        <div id="calendar"></div>
                        <div class="status-legend">
                            <div class="status-item">
                                <div class="status-dot submitted"></div>
                                <span>已提交</span>
                            </div>
                            <div class="status-item">
                                <div class="status-dot missing"></div>
                                <span>未提交</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer mt-auto py-3 bg-light">
        <div class="container text-center">
            <span class="text-muted">© 2024 工作管理系统</span>
        </div>
    </footer>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- FullCalendar JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/zh-cn.js"></script>
    <script>
        let calendar;

        // 初始化日历
        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'zh-cn',
                height: 'auto',
                headerToolbar: {
                    left: 'prev',
                    center: 'title',
                    right: 'next'
                },
                firstDay: 1, // 设置周一为一周的第一天
                dayCellDidMount: function(info) {
                    // 这里会在后面的 loadReportStatus 中处理日期标记
                },
                datesSet: function(info) {
                    // 当日历视图改变时（如切换月份）重新加载状态
                    loadReportStatus(info.view.currentStart);
                }
            });
            calendar.render();
        }

        // 加载日报提交状态
        function loadReportStatus(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            
            fetch(`/api/reports/status?year=${year}&month=${month}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 清除所有已有的标记
                        document.querySelectorAll('.report-submitted, .report-missing').forEach(el => {
                            el.classList.remove('report-submitted', 'report-missing');
                        });

                        // 创建日期到状态的映射
                        const statusMap = {};
                        data.data.forEach(item => {
                            statusMap[item.date] = item.submitted;
                        });

                        // 为每个工作日添加标记
                        const cells = document.querySelectorAll('.fc-daygrid-day');
                        cells.forEach(cell => {
                            const date = cell.getAttribute('data-date');
                            const dayOfWeek = new Date(date).getDay();
                            
                            // 对于工作日
                            if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                                if (date in statusMap) {
                                    cell.classList.add(statusMap[date] ? 'report-submitted' : 'report-missing');
                                } else {
                                    cell.classList.add('report-missing');
                                }
                            }
                            // 对于周末，只在提交了日报时显示绿点
                            else if (statusMap[date]) {
                                cell.classList.add('report-submitted');
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('加载日报状态失败:', error);
                });
        }

        // 加载统计数据
        function loadStats() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            
            fetch(`/api/reports/stats/monthly?year=${year}&month=${month}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateProjectHoursList(data.data.project_stats);
                        updateDailyHoursChart(data.data.daily_stats);
                    }
                })
                .catch(error => {
                    console.error('加载统计数据失败:', error);
                });
        }

        // 更新项目工时列表
        function updateProjectHoursList(projectStats) {
            const container = document.getElementById('projectHoursList');
            container.innerHTML = '';
            
            projectStats.forEach(stat => {
                const item = document.createElement('div');
                item.className = 'project-hours-item';
                item.innerHTML = `
                    <span class="project-name">${stat.project_name}</span>
                    <span class="project-hours">${stat.total_hours} 小时</span>
                `;
                container.appendChild(item);
            });
        }

        // 更新每日工时趋势图
        let dailyHoursChart = null; // 添加全局变量

        function updateDailyHoursChart(dailyStats) {
            const ctx = document.getElementById('dailyHoursChart');
            if (!ctx) return;
            
            if (dailyHoursChart instanceof Chart) {
                dailyHoursChart.destroy();
            }
            
            const projectsMap = new Map();
            dailyStats.forEach(day => {
                if (day.project_hours) {
                    day.project_hours.forEach(ph => {
                        if (ph && ph.project_id && ph.project_name) {
                            projectsMap.set(ph.project_id, ph.project_name);
                        }
                    });
                }
            });
            
            const datasets = Array.from(projectsMap.entries()).map(([id, name]) => {
                const color = getRandomColor();
                const data = dailyStats.map(day => {
                    const projectHours = day.project_hours ? 
                        day.project_hours.find(ph => ph && ph.project_id === id) : null;
                    return projectHours ? projectHours.total_hours : 0;
                });
                
                return {
                    label: name,
                    data: data,
                    borderColor: color,
                    backgroundColor: color,
                    fill: false,
                    tension: 0.4,
                    borderWidth: 2,
                    pointBackgroundColor: color,
                    pointBorderColor: color
                };
            });
            
            if (datasets.length === 0) {
                datasets.push({
                    label: '暂无数据',
                    data: new Array(dailyStats.length).fill(0),
                    borderColor: '#A0AEC0',
                    backgroundColor: '#A0AEC0',
                    fill: false,
                    tension: 0.4,
                    borderWidth: 2,
                    pointBackgroundColor: '#A0AEC0',
                    pointBorderColor: '#A0AEC0'
                });
            }
            
            dailyHoursChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dailyStats.map(day => {
                        const date = new Date(day.date);
                        return `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    }),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '当月工时趋势',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                boxWidth: 10,
                                boxHeight: 10
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1a202c',
                            bodyColor: '#4a5568',
                            borderColor: '#e2e8f0',
                            borderWidth: 1,
                            padding: 10,
                            callbacks: {
                                title: function(tooltipItems) {
                                    const date = new Date(dailyStats[tooltipItems[0].dataIndex].date);
                                    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                                },
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y} 小时`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '工时',
                                padding: {
                                    bottom: 10
                                }
                            },
                            grid: {
                                color: '#e2e8f0'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + ' 小时';
                                },
                                padding: 8
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 15,
                                padding: 8
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 4,
                            hoverRadius: 6,
                            borderWidth: 0
                        },
                        line: {
                            borderWidth: 2
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }

        // 生成随机颜色
        function getRandomColor() {
            // 预定义四种色系的颜色数组
            const colorPalettes = [
                // 蓝色系
                ['#4B89DC', '#5D9CEC', '#3498DB', '#2980B9', '#1F5B8C'],
                // 绿色系
                ['#2ECC71', '#48CFAD', '#37BC9B', '#16A085', '#27AE60'],
                // 紫色系
                ['#9B59B6', '#8E44AD', '#AC92EC', '#967ADC', '#8067B7'],
                // 橙色系
                ['#E67E22', '#F39C12', '#F6B042', '#E08E0B', '#D35400']
            ];

            // 从四个色系中循环选择颜色
            const paletteIndex = window.currentPaletteIndex || 0;
            const palette = colorPalettes[paletteIndex];
            const color = palette[Math.floor(Math.random() * palette.length)];
            
            // 更新索引，循环使用四种色系
            window.currentPaletteIndex = (paletteIndex + 1) % colorPalettes.length;
            
            return color;
        }

        // 检查登录状态
        function checkLoginStatus() {
            fetch('/api/user/info')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('username').textContent = data.data.username;
                        document.getElementById('userDropdown').classList.remove('d-none');
                        document.getElementById('loginLink').classList.add('d-none');
                        
                        // 如果是管理员，显示相关链接
                        if (data.data.role === 'admin') {
                            document.getElementById('analyticsLink').classList.remove('d-none');
                            document.getElementById('projectsLink').classList.remove('d-none');
                        }
                        
                        // 加载统计数据
                        loadStats();
                        // 初始化并加载日历
                        initCalendar();
                    } else {
                        document.getElementById('userDropdown').classList.add('d-none');
                        document.getElementById('loginLink').classList.remove('d-none');
                    }
                })
                .catch(error => {
                    console.error('Error checking login status:', error);
                    document.getElementById('userDropdown').classList.add('d-none');
                    document.getElementById('loginLink').classList.remove('d-none');
                });
        }

        // 处理退出登录
        function handleLogout() {
            document.cookie = 'token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            window.location.href = '/login';
        }

        // 页面加载时检查登录状态
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
        });
    </script>
</body>
</html> 